<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>文章 - 汉语古音手册</title>
  <link rel="icon" href="https://pic1.imgdb.cn/item/698dc2031d67521e9b492114.png" type="image/png" />
  <link rel="prefetch" href="index.html" as="document" />
  <link rel="prefetch" href="articles.html" as="document" />
  <link rel="prefetch" href="articles/catalog.md" as="fetch" crossorigin />
  <link rel="dns-prefetch" href="//cdn.jsdelivr.net" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
  <link rel="shortcut icon" href="https://pic1.imgdb.cn/item/698dc2031d67521e9b492114.png" />
  <link rel="apple-touch-icon" href="https://pic1.imgdb.cn/item/698dc2031d67521e9b492114.png" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.11.1/styles/github.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" />
  <style>
    :root{
      --bar-height:64px;--footer-height:50px;--bar-pad-x:18px;--bar-pad-y:12px;
      --glass-bg:rgba(255,255,255,0.35);--glass-border:1px solid rgba(208,215,230,0.72);
      --font-sans:'HarmonyOS Sans SC','HarmonyOS Sans','PingFang SC','Microsoft YaHei','Noto Sans CJK SC','Segoe UI',sans-serif;
      --btn-radius:10px;
      --bottom-safe:calc(var(--footer-height) + 96px);
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0}
    body{font-family:var(--font-sans);line-height:1.75;color:#1f3349;background:#ecf2f9;padding-top:var(--bar-height);padding-bottom:var(--bottom-safe)}

    .topbar{position:fixed;top:0;left:0;right:0;z-index:1000;background:rgba(255,255,255,0.35);-webkit-backdrop-filter:blur(15px) saturate(130%);backdrop-filter:blur(15px) saturate(130%);padding:var(--bar-pad-y) var(--bar-pad-x);box-shadow:0 2px 12px rgba(11,59,102,0.08);height:var(--bar-height);box-sizing:border-box;border-bottom:1px solid rgba(230,233,239,0.6);display:flex;align-items:center;gap:12px}
    .brand{font-weight:700;font-size:18px;color:#2b6cb0;white-space:nowrap;text-decoration:none}
    .topbar-warning{color:#e74c3c;font-size:12px;font-weight:500;margin-right:auto}
    .topbar-actions{display:flex;align-items:center;gap:8px}
    .glass-btn{padding:8px 12px;background:var(--glass-bg);color:#2b6cb0;border:var(--glass-border);border-radius:var(--btn-radius);cursor:pointer;transition:all .2s;font-size:13px;text-decoration:none;-webkit-backdrop-filter:blur(12px) saturate(125%);backdrop-filter:blur(12px) saturate(125%)}
    .glass-btn:hover{background:rgba(43,108,176,0.25);transform:translateY(-1px);box-shadow:0 4px 12px rgba(43,108,176,0.2)}

    .layout{width:min(1280px,calc(100vw - 32px));margin:20px auto;display:grid;grid-template-columns:minmax(0,1fr) 290px;gap:20px}
    .article-shell{background:var(--glass-bg);border:var(--glass-border);border-radius:18px;backdrop-filter:blur(12px) saturate(125%);box-shadow:0 14px 36px rgba(14,27,46,.08);overflow:hidden}
    .article-header{position:relative;isolation:isolate;overflow:hidden;padding:24px 26px;border-bottom:1px solid rgba(208,215,230,0.6);background:linear-gradient(180deg,rgba(255,255,255,.5),rgba(255,255,255,.22))}
    .article-header::before{content:'';position:absolute;inset:0;background-image:var(--cover-image,none);background-size:cover;background-position:center;opacity:.16;filter:blur(2px) saturate(1.05);z-index:-1}
    .article-header h1{margin:0 0 8px;font-size:clamp(28px,4vw,40px);line-height:1.2;color:#173c64}
    .article-meta{display:flex;gap:8px;align-items:center;color:#5d7592;font-size:13px}

    .content{padding:26px;font-size:17px;line-height:1.9}
    .content h2,.content h3,.content h4{margin:1.4em 0 .45em;line-height:1.35;color:#173c64;scroll-margin-top:82px}
    .content p{margin:.75em 0}
    .content a{color:#2b6cb0;text-underline-offset:3px}
    .content pre{border-radius:12px;border:var(--glass-border);overflow:auto;padding:14px;background:rgba(247,250,255,.95)}
    .content code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono',monospace;font-size:.92em}
    .content blockquote{margin:1.2em 0;padding:8px 14px;border-left:4px solid rgba(43,108,176,.32);background:rgba(43,108,176,.08);border-radius:8px;color:#304861}
    .content img{max-width:100%;border-radius:12px;border:var(--glass-border);box-shadow:0 10px 22px rgba(15,31,53,.08)}

    .demo-row{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0}
    .demo-fab{width:40px;height:40px;border-radius:10px;border:var(--glass-border);background:var(--glass-bg);display:inline-flex;align-items:center;justify-content:center;color:#2b6cb0;box-shadow:0 4px 12px rgba(43,108,176,.2)}

    .toc{position:sticky;top:74px;align-self:start;background:var(--glass-bg);border:var(--glass-border);border-radius:16px;backdrop-filter:blur(12px) saturate(125%);box-shadow:0 14px 36px rgba(14,27,46,.08);padding:14px;max-height:calc(100vh - 88px);overflow:auto}
    .toc h3{margin:0 0 10px;font-size:13px;letter-spacing:.08em;color:#2b6cb0}
    .toc a{display:block;padding:6px 8px;margin:2px 0;border-radius:8px;text-decoration:none;color:#35516e;font-size:13px;opacity:.62;transform:scale(.94);transform-origin:left center;transition:background .22s,transform .22s,opacity .22s,color .22s}
    .toc a.level-3{padding-left:16px;font-size:12px;color:#546c85}
    .toc a:hover{background:rgba(43,108,176,.12);transform:translateX(1px) scale(.96);opacity:.9}
    .toc a.active{opacity:1;transform:scale(1);color:#1f4f86;background:rgba(43,108,176,.2);box-shadow:inset 2px 0 0 rgba(43,108,176,.55);font-weight:700}

    .article-tools{margin:8px 26px 28px;padding:16px;border-radius:14px;border:var(--glass-border);background:rgba(255,255,255,.52);display:grid;grid-template-columns:110px 1fr;gap:14px;align-items:center}
    .article-tools img.qr{width:110px;height:110px;border-radius:10px;border:var(--glass-border);background:#fff}
    .tools-main{display:flex;flex-direction:column;gap:10px}
    .tools-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .tools-actions .glass-btn{display:inline-flex;align-items:center;justify-content:center;height:36px;line-height:1;padding:0 12px;font-size:13px}
    .editor{display:flex;align-items:center;gap:8px;color:#4f6882;font-size:13px;line-height:1.4}
    .editor img{width:32px;height:32px;border-radius:999px;border:1px solid rgba(208,215,230,.8)}

    .side-fab{position:fixed;right:30px;width:48px;height:48px;background:var(--glass-bg);color:#2b6cb0;border:var(--glass-border);border-radius:var(--btn-radius);cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:1200;opacity:0;transform:translateY(8px);pointer-events:none;transition:opacity .24s ease,transform .24s ease,background-color .22s ease,box-shadow .22s ease;box-shadow:0 4px 12px rgba(43,108,176,.2);-webkit-backdrop-filter:blur(16px) saturate(140%);backdrop-filter:blur(16px) saturate(140%);padding:0;text-decoration:none}
    .side-fab:hover{background:rgba(43,108,176,.3);transform:translateY(0);box-shadow:0 6px 16px rgba(43,108,176,.3)}
    .side-fab.show{opacity:1;transform:none;pointer-events:auto}
    .side-fab svg{width:18px;height:18px;fill:none !important;stroke:currentColor !important;stroke-width:2.5;stroke-linecap:round;stroke-linejoin:round}
    #page-prev{bottom:calc(var(--footer-height) + 150px)}
    #page-next{bottom:calc(var(--footer-height) + 210px)}
    #page-all{bottom:calc(var(--footer-height) + 90px)}
    .page-btn{right:20px;opacity:1 !important;transform:none !important;pointer-events:auto !important}
    .side-fab[disabled]{opacity:.38;pointer-events:none}

    #toc-toggle{display:none !important;left:12px;right:auto;bottom:calc(var(--footer-height) + 30px);width:48px;height:48px;padding:0;border-radius:var(--btn-radius)}
    .toc-overlay{display:none}

    footer.site-footer{position:fixed !important;left:0 !important;right:0 !important;bottom:0 !important;width:100% !important;max-width:none !important;z-index:1000 !important;margin:0 !important;border-radius:0 !important;background:var(--glass-bg) !important;-webkit-backdrop-filter:blur(18px) saturate(145%) !important;backdrop-filter:blur(18px) saturate(145%) !important;padding:8px 12px !important;height:var(--footer-height) !important;box-sizing:border-box !important;border-top:1px solid rgba(230,233,239,0.6) !important;border-left:0 !important;border-right:0 !important;border-bottom:0 !important;box-shadow:none !important;display:flex;align-items:center;justify-content:center;text-align:center;color:#666;font-size:13px}
    .footer-content{display:flex;align-items:center;gap:8px;white-space:nowrap}
    .footer-link{display:inline-flex;align-items:center;gap:4px;color:#2b6cb0;text-decoration:none;opacity:.85;transition:opacity .2s,transform .2s}
    .footer-link:hover{opacity:1;transform:translateY(-1px)}
    .footer-link svg{width:12px;height:12px;display:block}
    @supports not ((-webkit-backdrop-filter: blur(1px)) or (backdrop-filter: blur(1px))){
      .topbar,.glass-btn,.article-shell,.toc,.side-fab,footer.site-footer{background:rgba(255,255,255,0.78) !important}
    }

    @media (min-width:981px){
      #toc-toggle{display:none !important}
    }
    @media (max-width:980px){
      :root{--bar-height:72px;--footer-height:64px}
      body{padding-top:82px}
      .topbar{padding:0;height:0;background:transparent;backdrop-filter:none;border:0;box-shadow:none}
      .brand,.topbar-warning,.topbar-actions{display:none}
      .layout{grid-template-columns:1fr;width:calc(100vw - 20px);margin-top:12px}
      .toc{position:fixed;right:12px;top:64px;width:min(88vw,320px);max-height:calc(100vh - 126px);z-index:700;transform:translateX(120%);opacity:0;pointer-events:none;transition:transform .26s ease,opacity .26s ease}
      body.toc-open .toc{transform:translateX(0);opacity:1;pointer-events:auto}
      #toc-toggle{display:inline-flex !important;align-items:center;justify-content:center;opacity:1;pointer-events:auto;top:10px;bottom:auto;right:10px;left:auto}
      #mobile-home-btn{display:inline-flex !important;top:10px;left:10px;bottom:auto;right:auto;opacity:1;pointer-events:auto}
      .toc-overlay{display:block;position:fixed;inset:0;background:rgba(10,22,38,.32);backdrop-filter:blur(3px);z-index:650;opacity:0;pointer-events:none;transition:opacity .25s ease}
      body.toc-open .toc-overlay{opacity:1;pointer-events:auto}
      .article-header,.content{padding:18px}
      .article-tools{margin:8px 18px 24px;grid-template-columns:1fr}
      .article-tools img.qr{width:140px;height:140px}
      .side-fab svg{width:20px;height:20px}
      #page-prev{bottom:174px;right:16px}
      #page-next{bottom:234px;right:16px}
      #page-all{bottom:114px;right:16px}
      .page-btn{right:16px}
      .glass-btn{min-height:44px}
      footer.site-footer{inset:auto 12px 10px 12px !important;width:auto !important;max-width:none !important;border-radius:14px !important;height:64px !important;padding:10px 12px !important;border:1px solid rgba(230,233,239,0.6) !important;box-shadow:0 -2px 10px rgba(11,59,102,0.06) !important}
    }
  </style>
</head>
<body>
  <header class="topbar">
    <a class="brand" href="index.html">汉语古音手册</a>
    <div class="topbar-warning">※ 仅支持繁体字</div>
    <div class="topbar-actions">
      <a class="glass-btn" href="index.html">返回词典</a>
    </div>
  </header>

  <button id="toc-toggle" class="side-fab" type="button" title="目录">目录</button>
  <a id="mobile-home-btn" class="side-fab" href="index.html" title="主页" aria-label="主页">
    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 11.5L12 4l9 7.5"></path><path d="M6.5 10.5V20h11v-9.5"></path></svg>
  </a>
  <div id="toc-overlay" class="toc-overlay"></div>

  <main class="layout">
    <article class="article-shell">
      <header class="article-header">
        <h1 id="article-title">加载中...</h1>
        <div id="article-meta" class="article-meta">-</div>
      </header>
      <section id="article-content" class="content"><p>正在加载文章...</p></section>
      <section class="article-tools">
        <img id="article-qr" class="qr" alt="文章二维码" />
        <div class="tools-main">
          <div style="font-size:14px;color:#2b6cb0;font-weight:600">移动端阅读与分享</div>
          <div class="tools-actions">
            <a href="articles.html" class="glass-btn">文章总览</a>
            <button id="native-share-btn" class="glass-btn" type="button">分享给好友</button>
          </div>
          <div class="editor">
            <img src="https://pic1.imgdb.cn/item/69328494d1e741a32bf1ba21.jpg" alt="Takion Kroslin" />
            <span>编辑人：Takion Kroslin</span>
          </div>
        </div>
      </section>
    </article>

    <aside id="toc" class="toc">
      <h3>CATALOG</h3>
      <div id="toc-list"><p>目录生成中...</p></div>
    </aside>
  </main>

  <button id="page-prev" class="side-fab page-btn" title="上一篇" aria-label="上一篇">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="15 18 9 12 15 6"></polyline>
    </svg>
  </button>
  <button id="page-next" class="side-fab page-btn" title="下一篇" aria-label="下一篇">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </button>
  <a id="page-all" class="side-fab page-btn" href="articles.html" title="全部文章" aria-label="全部文章">文</a>

  <footer class="site-footer">
    <div class="footer-content">
      <span>© 2026 Takion Kroslin</span>
      <span>|</span>
      <a href="https://github.com/TakionKroslin/dictionary" target="_blank" class="footer-link" title="GitHub" aria-label="GitHub">
        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 .5C5.65.5.5 5.66.5 12.02c0 5.09 3.3 9.41 7.88 10.94.58.1.79-.25.79-.56v-2.02c-3.2.69-3.88-1.55-3.88-1.55-.53-1.33-1.28-1.69-1.28-1.69-1.04-.71.08-.7.08-.7 1.15.09 1.75 1.18 1.75 1.18 1.01 1.75 2.67 1.24 3.33.95.1-.73.4-1.24.72-1.52-2.56-.29-5.25-1.28-5.25-5.69 0-1.26.45-2.3 1.18-3.11-.12-.29-.51-1.46.11-3.04 0 0 .96-.31 3.15 1.19a10.8 10.8 0 0 1 5.74 0c2.18-1.5 3.14-1.19 3.14-1.19.62 1.58.23 2.75.11 3.04.73.81 1.18 1.85 1.18 3.11 0 4.42-2.7 5.4-5.27 5.68.41.36.78 1.07.78 2.15v3.19c0 .31.21.67.8.56a11.54 11.54 0 0 0 7.87-10.94C23.5 5.66 18.35.5 12 .5z"/></svg>
        <span>GitHub</span>
      </a>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.11.1/lib/highlight.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.11.1/lib/languages/javascript.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.11.1/lib/languages/python.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.11.1/lib/languages/bash.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"></script>
  <script>
    (function(){
      const DEFAULT_META = { title: '未命名文章', date: '未知日期', author: 'Takion Kroslin', cover: '' };
      const CATALOG_PATH = 'articles/catalog.md';
      const params = new URLSearchParams(location.search);
      const mdPath = params.get('file');
      const titleEl = document.getElementById('article-title');
      const metaEl = document.getElementById('article-meta');
      const contentEl = document.getElementById('article-content');
      const tocListEl = document.getElementById('toc-list');
      const prevBtn = document.getElementById('page-prev');
      const nextBtn = document.getElementById('page-next');
      const qrEl = document.getElementById('article-qr');
      const tocToggle = document.getElementById('toc-toggle');
      const tocOverlay = document.getElementById('toc-overlay');
      let tocObserver = null;
      let markdownEngineReady = false;

      function safePath(path){
        if(!path) return '';
        const p = path.replace(/\\/g, '/');
        if(!p.startsWith('articles/')) return '';
        if(p.includes('..')) return '';
        return p;
      }

      function parseCatalog(md){
        const out = [];
        for(const raw of (md || '').split(/\r?\n/)){
          const line = raw.trim();
          const m = line.match(/^- \[(.+?)\]\((.+?)\)\s*\|\s*([^|]+?)\s*\|\s*([^|]+?)(?:\s*\|\s*(.+))?$/);
          if(!m) continue;
          out.push({ title:m[1].trim(), path:m[2].trim(), date:m[3].trim(), author:m[4].trim(), summary:(m[5]||'').trim() });
        }
        return out;
      }

      function parseAttributes(attrText){
        const attrs = {};
        const re = /(\w+)\s*=\s*"([^"]*)"/g;
        let m;
        while((m = re.exec(attrText))){ attrs[m[1].toLowerCase()] = m[2]; }
        return attrs;
      }

      function extractArticleMeta(md, fallback){
        const meta = { ...fallback };
        let text = md || '';
        const tagMatch = text.match(/<article-meta\s+([^>]*?)\s*><\/article-meta>/i) || text.match(/<article-meta\s+([^>]*?)\s*\/>/i);
        if(tagMatch){
          const attrs = parseAttributes(tagMatch[1] || '');
          meta.title = attrs.title || meta.title;
          meta.date = attrs.date || meta.date;
          meta.author = attrs.author || meta.author;
          meta.cover = attrs.cover || meta.cover;
          text = text.replace(tagMatch[0], '').trimStart();
        }
        text = text.replace(/^#\s+.+\n+/,'');
        text = text.replace(/^!\[[^\]]*\]\([^\)]+\)\s*\n+/,'');
        return { meta, markdown: text };
      }

      function createSlug(text){
        return (text || '').toLowerCase().replace(/[\s\u3000]+/g,'-').replace(/[^\w\u4e00-\u9fa5-]/g,'').replace(/-+/g,'-').replace(/^-|-$/g,'') || 'section';
      }

      function decodeHashValue(hash){
        try{ return decodeURIComponent(hash); }catch(_){ return hash; }
      }

      function setActiveToc(id){
        tocListEl.querySelectorAll('a').forEach((a)=>{
          a.classList.toggle('active', decodeHashValue(a.hash.slice(1)) === id);
        });
      }

      function setupTocTracking(headings){
        if(tocObserver) tocObserver.disconnect();
        if(!headings.length) return;
        const visible = new Map();
        tocObserver = new IntersectionObserver((entries)=>{
          for(const e of entries){ visible.set(e.target.id, e.isIntersecting ? e.boundingClientRect.top : Infinity); }
          let candidate = null;
          let bestTop = Infinity;
          for(const h of headings){
            const top = visible.get(h.id);
            if(typeof top !== 'number') continue;
            if(top < bestTop){ bestTop = top; candidate = h.id; }
          }
          if(!candidate){
            const passed = headings.filter((h)=>h.getBoundingClientRect().top <= 140).map((h)=>h.id);
            candidate = passed[passed.length - 1] || headings[0].id;
          }
          setActiveToc(candidate);
        }, { root:null, rootMargin:'-20% 0px -60% 0px', threshold:[0,.1,.3,.6,1] });
        headings.forEach((h)=>tocObserver.observe(h));
        setActiveToc(headings[0].id);
      }

      function buildToc(){
        const headings = Array.from(contentEl.querySelectorAll('h2,h3'));
        if(!headings.length){ tocListEl.innerHTML = '<p>本文暂无二级目录。</p>'; return; }
        tocListEl.innerHTML = '';
        const used = new Map();
        for(const h of headings){
          let id = h.id || createSlug(h.textContent);
          const n = (used.get(id) || 0) + 1;
          used.set(id, n);
          if(n > 1) id = `${id}-${n}`;
          h.id = id;
          const a = document.createElement('a');
          a.href = `#${encodeURIComponent(id)}`;
          a.className = h.tagName === 'H3' ? 'level-3' : 'level-2';
          a.textContent = h.textContent || '未命名';
          tocListEl.appendChild(a);
        }
        bindTocInteractions();
        setupTocTracking(headings);
      }

      function bindTocInteractions(){
        tocListEl.querySelectorAll('a').forEach((a)=>{
          a.addEventListener('click', (e)=>{
            e.preventDefault();
            const id = decodeHashValue(a.hash.slice(1));
            const target = document.getElementById(id);
            if(target){
              setActiveToc(id);
              target.scrollIntoView({ behavior:'smooth', block:'start' });
              history.replaceState(null, '', `#${encodeURIComponent(id)}`);
              document.body.classList.remove('toc-open');
            }
          });
        });
      }

      function setupRenderer(){
        markdownEngineReady = typeof marked !== 'undefined';
        if(!markdownEngineReady) return;
        marked.setOptions({
          gfm:true, breaks:false, mangle:false, headerIds:false,
          highlight(code,lang){
            if(typeof hljs === 'undefined') return code;
            if(lang && hljs.getLanguage(lang)) return hljs.highlight(code,{language:lang}).value;
            return hljs.highlightAuto(code).value;
          }
        });
      }

      function escapeHtml(s){
        return (s || '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');
      }

      function renderMarkdownFallback(md){
        const lines = (md || '').split(/\r?\n/);
        const html = [];
        let inCode = false;
        for(const line of lines){
          if(line.startsWith('```')){
            if(!inCode){ html.push('<pre><code>'); inCode = true; }
            else { html.push('</code></pre>'); inCode = false; }
            continue;
          }
          if(inCode){ html.push(`${escapeHtml(line)}\n`); continue; }
          if(/^###\s+/.test(line)){ html.push(`<h3>${escapeHtml(line.replace(/^###\s+/, ''))}</h3>`); continue; }
          if(/^##\s+/.test(line)){ html.push(`<h2>${escapeHtml(line.replace(/^##\s+/, ''))}</h2>`); continue; }
          if(/^-\s+/.test(line)){ html.push(`<p>• ${escapeHtml(line.replace(/^-\s+/, ''))}</p>`); continue; }
          if(/^\d+\.\s+/.test(line)){ html.push(`<p>${escapeHtml(line)}</p>`); continue; }
          if(!line.trim()){ html.push(''); continue; }
          html.push(`<p>${escapeHtml(line)}</p>`);
        }
        contentEl.innerHTML = html.join('\n');
        buildToc();
      }

      function renderMarkdown(md){
        if(!markdownEngineReady){
          renderMarkdownFallback(md);
          return;
        }
        contentEl.innerHTML = marked.parse(md);
        if(typeof hljs !== 'undefined'){
          contentEl.querySelectorAll('pre code').forEach((b)=>hljs.highlightElement(b));
        }
        if(window.renderMathInElement){
          window.renderMathInElement(contentEl,{delimiters:[
            { left:'$$', right:'$$', display:true },
            { left:'$', right:'$', display:false },
            { left:'\\(', right:'\\)', display:false },
            { left:'\\[', right:'\\]', display:true }
          ],throwOnError:false});
        }
        buildToc();
      }

      function setQr(){
        qrEl.src = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(location.href)}`;
      }

      function setupShare(){
        const nativeBtn = document.getElementById('native-share-btn');
        async function copyLink(btn){
          await navigator.clipboard.writeText(location.href);
          const t = btn.textContent;
          btn.textContent = '链接已复制';
          setTimeout(()=>btn.textContent=t,1600);
        }
        nativeBtn?.addEventListener('click', async ()=>{
          if(navigator.share){
            try{ await navigator.share({ title: titleEl.textContent, text: titleEl.textContent, url: location.href }); }catch(_){ }
          }else{
            copyLink(nativeBtn).catch(()=>{});
          }
        });
      }

      function bindTocMobile(){
        tocToggle?.addEventListener('click', ()=>document.body.classList.toggle('toc-open'));
        tocOverlay?.addEventListener('click', ()=>document.body.classList.remove('toc-open'));
        window.addEventListener('resize', ()=>{ if(window.innerWidth > 980) document.body.classList.remove('toc-open'); });
      }

      function bindHashSync(){
        window.addEventListener('hashchange', ()=>{
          const id = decodeHashValue(location.hash.slice(1));
          if(id) setActiveToc(id);
        });
      }

      function setupPrevNext(catalog, currentPath){
        const idx = catalog.findIndex((it)=>it.path === currentPath);
        const prev = idx > 0 ? catalog[idx - 1] : null;
        const next = idx >= 0 && idx < catalog.length - 1 ? catalog[idx + 1] : null;
        prevBtn.disabled = !prev;
        nextBtn.disabled = !next;
        prevBtn.onclick = prev ? ()=>location.href = `article.html?file=${encodeURIComponent(prev.path)}` : null;
        nextBtn.onclick = next ? ()=>location.href = `article.html?file=${encodeURIComponent(next.path)}` : null;
      }

      async function load(){
        const safe = safePath(mdPath);
        if(!safe){
          titleEl.textContent = '无效文章路径';
          metaEl.textContent = '请从首页文章目录进入';
          contentEl.innerHTML = '<p>参数 file 无效或超出 articles/ 目录。</p>';
          return;
        }

        let catalog = [];
        let catalogMeta = null;
        try{
          const ctext = await fetch(CATALOG_PATH,{cache:'no-cache'}).then((r)=>r.text());
          catalog = parseCatalog(ctext);
          catalogMeta = catalog.find((it)=>it.path === safe) || null;
          setupPrevNext(catalog, safe);
        }catch(_){ prevBtn.disabled = true; nextBtn.disabled = true; }

        try{
          const mdRaw = await fetch(safe,{cache:'no-cache'}).then((r)=>{ if(!r.ok) throw new Error(`HTTP ${r.status}`); return r.text(); });
          const fallback = { ...DEFAULT_META, ...(catalogMeta || {}) };
          const { meta, markdown } = extractArticleMeta(mdRaw, fallback);
          titleEl.textContent = meta.title || DEFAULT_META.title;
          metaEl.textContent = `${meta.author || DEFAULT_META.author} · ${meta.date || DEFAULT_META.date}`;
          const coverValue = (meta.cover || '').replace(/'/g, '%27');
          document.documentElement.style.setProperty('--cover-image', coverValue ? `url('${coverValue}')` : 'none');
          document.title = `${titleEl.textContent} - 汉语古音手册`;
          setupRenderer();
          renderMarkdown(markdown);
          if(location.hash){
            const hid = decodeHashValue(location.hash.slice(1));
            const hTarget = document.getElementById(hid);
            if(hTarget){
              setTimeout(()=>hTarget.scrollIntoView({ behavior:'smooth', block:'start' }), 60);
              setActiveToc(hid);
            }
          }
          setQr();
        }catch(err){
          titleEl.textContent = '文章加载失败';
          metaEl.textContent = String(err.message || err);
          contentEl.innerHTML = '<p>无法读取文章文件，请检查路径或刷新重试。</p>';
          tocListEl.innerHTML = '<p>-</p>';
          prevBtn.disabled = true;
          nextBtn.disabled = true;
        }
      }

      bindTocMobile();
      bindHashSync();
      setupShare();
      load();
    })();
  </script>
</body>
</html>
